<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自動車維持費計算ツール</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 30px auto;
            background-color: #ffffff;
            padding: 30px 40px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        h2 {
            text-align: center;
            color: #2c3e50;
            margin-top: 30px;
            margin-bottom: 20px;
        }
        h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }
        hr {
            border: 0;
            border-top: 1px dashed #ccc;
            margin: 30px 0;
        }
        .input-section {
            display: flex;
            justify-content: space-around;
            gap: 30px;
            flex-wrap: wrap;
        }
        .vehicle-input-column {
            flex: 1;
            min-width: 350px;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 8px;
            background-color: #fcfcfc;
        }
        .vehicle-input-column h3 {
            margin-top: 0;
            margin-bottom: 25px;
            text-align: left;
            color: #4CAF50;
        }

        .input-group {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        .input-group label {
            flex: 0 0 160px;
            margin-bottom: 0;
            margin-right: 10px;
            font-weight: bold;
            color: #555;
        }
        .input-group input[type="number"], 
        .input-group input[type="date"], 
        .input-group select,
        .input-group input[type="text"] {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 15px;
            box-sizing: border-box;
            width: auto;
        }
        .input-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }
        .input-group input[type="number"]:focus, 
        .input-group input[type="date"]:focus, 
        .input-group select:focus,
        .input-group input[type="text"]:focus {
            border-color: #4CAF50;
            outline: none;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
        }
        .input-group .unit {
            margin-left: 10px;
            font-weight: bold;
            color: #555;
            flex-shrink: 0;
        }
        .info-text {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
            margin-bottom: 10px;
            flex-basis: 100%;
            text-align: left;
            padding-left: calc(160px + 10px); 
            box-sizing: border-box;
        }
        
        button {
            display: block;
            width: 100%;
            padding: 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-top: 30px;
            text-align: center;
            text-decoration: none;
        }
        button:hover {
            background-color: #45a049;
        }

        .result-section {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        .result-group {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        .result-item {
            flex: 1;
            min-width: 300px;
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            text-align: center;
        }
        .result-item h4 {
            margin-top: 0;
            color: #4CAF50;
        }
        .result-item p {
            font-size: 16px;
            margin: 0 0 5px 0;
            color: #555;
        }
        .result-item strong {
            font-size: 24px;
            color: #2c3e50;
            display: block;
            margin-top: 10px;
        }
        .result-item .monthly-avg {
            font-size: 14px;
            color: #666;
            margin-top: 8px;
            display: block;
        }

        .comparison-option {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #e9f5e9;
            border: 1px solid #c8e6c9;
            border-radius: 5px;
        }
        .comparison-option input[type="checkbox"] {
            margin-right: 10px;
            width: 20px;
            height: 20px;
        }
        .comparison-option label {
            font-size: 1.1em;
            font-weight: bold;
            color: #388e3c;
        }

        .toggle-section-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 12px;
            background-color: #f0f0f0;
            color: #333;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-top: 30px;
        }
        .toggle-section-button:hover {
            background-color: #e0e0e0;
        }
        .toggle-section-button .arrow {
            margin-left: 10px;
            transition: transform 0.3s ease;
        }
        .toggle-section-button.expanded .arrow {
            transform: rotate(90deg); 
        }
        .monthly-breakdown-container {
            display: none; 
            margin-top: 20px;
        }
        .monthly-breakdown-container.expanded {
            display: block;
        }

        .monthly-breakdown-table-wrapper {
            max-height: 500px;
            overflow-y: auto;
            overflow-x: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-top: 10px;
            position: relative;
        }

        .monthly-breakdown table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px;
            font-size: 14px;
        }
        .monthly-breakdown th, .monthly-breakdown td {
            border: 1px solid #ddd;
            padding: 10px 8px;
            text-align: right;
            white-space: nowrap; 
        }
        .monthly-breakdown thead th {
            position: sticky;
            top: 0;
            background-color: #e9eef2;
            font-weight: bold;
            text-align: center;
            z-index: 10;
        }
        .monthly-breakdown tbody td:first-child,
        .monthly-breakdown thead th:first-child {
            text-align: left;
            font-weight: bold;
            min-width: 100px;
        }
        .monthly-breakdown tbody tr:nth-child(odd) {
            background-color: #fcfcfc;
        }
        .monthly-breakdown tbody tr:nth-child(even) {
            background-color: #f6f6f6;
        }
        .monthly-breakdown tbody tr:hover {
            background-color: #e0f2f7;
        }
        .monthly-breakdown .total-row {
            background-color: #dceefc;
            font-weight: bold;
        }
        .monthly-breakdown .total-row td {
            font-size: 15px;
        }

        .chart-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            gap: 15px;
        }
        .chart-controls label {
            font-weight: bold;
            color: #555;
        }
        .chart-controls select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 15px;
        }
        .chart-container {
            position: relative;
            margin: 20px auto;
            width: 100%;
            max-width: 1000px;
        }
        
        /* --- CSVダウンロードボタンのスタイル --- */
        .csv-export-btn {
            position: absolute;
            top: -10px;
            right: 0; /* ★変更点: leftからrightに変更 */
            z-index: 20;
            width: auto;
            padding: 5px 10px;
            font-size: 12px;
            background-color: #f0f0f0;
            color: #333;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-top: 0;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .csv-export-btn:hover {
             background-color: #e0e0e0;
        }
        
        .disclaimer {
            font-size: 14px;
            color: #777;
            margin-top: 40px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>自動車維持費計算ツール</h1>

        <div class="input-group">
            <label for="startDate">計算開始日</label>
            <input type="date" id="startDate">
        </div>

        <div class="input-group">
            <label for="endDate">計算終了日</label>
            <input type="date" id="endDate">
        </div>

        <hr>

        <h2>車両・費用情報</h2>

        <div class="comparison-option">
            <input type="checkbox" id="compareVehicles" onchange="toggleVehicleComparison()">
            <label for="compareVehicles">2台の車両を比較する</label>
        </div>

        <div class="input-section">
            <div class="vehicle-input-column" id="vehicle1Inputs">
                <h3>車両 1</h3>
                <div class="input-group">
                    <label for="vehicle1Name">車両名</label>
                    <input type="text" id="vehicle1Name" value="現在の車">
                </div>
                <div class="input-group">
                    <label for="loanOption1">ローン計算</label>
                    <select id="loanOption1" onchange="toggleLoanFields(1)">
                        <option value="no">計算しない</option>
                        <option value="yes">計算する</option>
                    </select>
                </div>
                <div id="loanFields1" style="display: none;">
                    <div class="input-group">
                        <label for="loanAmount1">借入額</label>
                        <input type="number" id="loanAmount1" value="2000000" min="0">
                        <span class="unit">円</span>
                    </div>
                    <div class="input-group">
                        <label for="loanInterestRate1">ローン金利</label>
                        <input type="number" id="loanInterestRate1" value="3.5" min="0" step="0.01">
                        <span class="unit">%</span>
                    </div>
                    <div class="input-group">
                        <label for="loanTermMonths1">返済期間</label>
                        <input type="number" id="loanTermMonths1" value="60" min="0">
                        <span class="unit">ヶ月</span>
                    </div>
                </div>
                <div class="input-group">
                    <label for="fuelType1">燃料タイプ</label>
                    <select id="fuelType1" onchange="toggleFuelTypeFields(1)">
                        <option value="gasoline">ガソリン車</option>
                        <option value="diesel">ディーゼル車</option>
                        <option value="hybrid">ハイブリッド車</option>
                        <option value="ev">EV（電気自動車）</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="classificationType1">分類</label>
                    <select id="classificationType1" onchange="toggle1NumberFields(1)">
                        <option value="passenger">3/5ナンバー（乗用車）</option>
                        <option value="cargo">1ナンバー（貨物車）</option>
                    </select>
                </div>
                <div class="input-group" id="passengerCapacityGroup1" style="display: none;">
                    <label for="passengerCapacity1">乗車定員数</label>
                    <input type="number" id="passengerCapacity1" value="2" min="1">
                    <span class="unit">人</span>
                </div>
                <div class="input-group" id="maxLoadingCapacityGroup1" style="display: none;">
                    <label for="maxLoadingCapacity1">最大積載量</label>
                    <input type="number" id="maxLoadingCapacity1" value="500" min="0">
                    <span class="unit">kg</span>
                </div>
                <div class="input-group" id="displacementGroup1">
                    <label for="displacement1">排気量</label>
                    <input type="number" id="displacement1" value="1500" min="0">
                    <span class="unit">cc</span>
                </div>
                <div class="input-group">
                    <label for="weight1">車両重量</label>
                    <input type="number" id="weight1" value="1200" min="0">
                    <span class="unit">kg</span>
                </div>
                <div class="input-group">
                    <label for="firstRegistrationDate1">新規車検登録日</label>
                    <input type="date" id="firstRegistrationDate1">
                </div>
                 <div class="input-group">
                    <label for="isEcoCar1">エコカー減税対象</label>
                    <input type="checkbox" id="isEcoCar1">
                    <p class="info-text">※初回車検時の重量税が免除されます</p>
                </div>
                <div class="input-group">
                    <label for="nextInspectionDate1">直近車検満了日</label>
                    <input type="date" id="nextInspectionDate1">
                </div>
                <div class="input-group">
                    <label for="inspectionCostPerTime1">車検時整備費用</label>
                    <input type="number" id="inspectionCostPerTime1" value="60000" min="0">
                    <span class="unit">円/回</span>
                    <p class="info-text">※法定費用（重量税・自賠責・印紙代）を除いた金額</p>
                </div>
                <div class="input-group">
                    <label for="voluntaryInsurance1">任意保険料</label>
                    <input type="number" id="voluntaryInsurance1" value="60000" min="0">
                    <span class="unit">円/年</span>
                </div>
                <div class="input-group">
                    <label for="parkingCostMonthly1">駐車場代</label>
                    <input type="number" id="parkingCostMonthly1" value="0" min="0">
                    <span class="unit">円/月</span>
                </div>
                <div class="input-group">
                    <label for="monthlyMileage1">月間走行距離</label>
                    <input type="number" id="monthlyMileage1" value="800" min="0">
                    <span class="unit">km/月</span>
                </div>
                <div class="input-group gas-diesel-hybrid-only" id="fuelEfficiencyGroup1">
                    <label for="fuelEfficiency1">燃費</label>
                    <input type="number" id="fuelEfficiency1" value="15" min="0.1" step="0.1">
                    <span class="unit">km/L</span>
                </div>
                <div class="input-group gas-diesel-hybrid-only" id="fuelPriceGroup1">
                    <label for="fuelPrice1">燃料価格</label>
                    <input type="number" id="fuelPrice1" value="170" min="0">
                    <span class="unit">円/L</span>
                </div>
                <div class="input-group ev-only" id="electricityEfficiencyGroup1" style="display: none;">
                    <label for="electricityEfficiency1">電費</label>
                    <input type="number" id="electricityEfficiency1" value="6" min="0.1" step="0.1">
                    <span class="unit">km/kWh</span>
                </div>
                 <div class="input-group ev-only" id="electricityPriceGroup1" style="display: none;">
                    <label for="electricityPrice1">電気料金単価</label>
                    <input type="number" id="electricityPrice1" value="30" min="0">
                    <span class="unit">円/kWh</span>
                </div>
                <div class="input-group diesel-only" id="adblueCostGroup1" style="display: none;">
                    <label for="adblueCostPerL1">AdBlue費用</label>
                    <input type="number" id="adblueCostPerL1" value="500" min="0">
                    <span class="unit">円/L</span>
                    <p class="info-text">※10000km走行ごとに10L消費と仮定</p>
                </div>
                <div class="input-group gas-diesel-hybrid-only" id="oilElementCostGroup1">
                    <label for="oilElementCostPerTime1">オイル・エレメント費用</label>
                    <input type="number" id="oilElementCostPerTime1" value="10000" min="0">
                    <span class="unit">円/回</span>
                    <p class="info-text" id="oilInfoText1">※目安: 5000km(D) / 10000km(G/HV)</p>
                </div>
                 <div class="input-group hybrid-ev-only" id="hvBatteryCostGroup1" style="display: none;">
                    <label for="hvBatteryCost1">駆動用バッテリー費用</label>
                    <input type="number" id="hvBatteryCost1" value="200000" min="0">
                    <span class="unit">円/回</span>
                </div>
                <div class="input-group hybrid-ev-only" id="hvBatteryCycleGroup1" style="display: none;">
                    <label for="hvBatteryCycle1">バッテリー交換サイクル</label>
                    <input type="number" id="hvBatteryCycle1" value="10" min="1">
                    <span class="unit">年</span>
                </div>
                <div class="input-group">
                    <label for="tireCostPerSet1">タイヤ費用</label>
                    <input type="number" id="tireCostPerSet1" value="60000" min="0">
                    <span class="unit">円/4本</span>
                    <p class="info-text">※目安: 40000km</p>
                </div>
                 <div class="input-group">
                    <label for="otherMaintenanceCost1">その他メンテ費用</label>
                    <input type="number" id="otherMaintenanceCost1" value="20000" min="0">
                    <span class="unit">円/年</span>
                    <p class="info-text">※ブレーキ、補機バッテリー、ワイパー等</p>
                </div>
            </div>

            <div class="vehicle-input-column" id="vehicle2Inputs" style="display: none;">
                <h3>車両 2</h3>
                 <div class="input-group">
                    <label for="vehicle2Name">車両名</label>
                    <input type="text" id="vehicle2Name" value="買い替え検討車">
                </div>
                <div class="input-group">
                    <label for="loanOption2">ローン計算</label>
                    <select id="loanOption2" onchange="toggleLoanFields(2)">
                        <option value="no">計算しない</option>
                        <option value="yes" selected>計算する</option>
                    </select>
                </div>
                <div id="loanFields2">
                    <div class="input-group">
                        <label for="loanAmount2">借入額</label>
                        <input type="number" id="loanAmount2" value="3000000" min="0">
                        <span class="unit">円</span>
                    </div>
                    <div class="input-group">
                        <label for="loanInterestRate2">ローン金利</label>
                        <input type="number" id="loanInterestRate2" value="2.8" min="0" step="0.01">
                        <span class="unit">%</span>
                    </div>
                    <div class="input-group">
                        <label for="loanTermMonths2">返済期間</label>
                        <input type="number" id="loanTermMonths2" value="72" min="0">
                        <span class="unit">ヶ月</span>
                    </div>
                </div>
                <div class="input-group">
                    <label for="fuelType2">燃料タイプ</label>
                    <select id="fuelType2" onchange="toggleFuelTypeFields(2)">
                        <option value="gasoline">ガソリン車</option>
                        <option value="diesel">ディーゼル車</option>
                        <option value="hybrid" selected>ハイブリッド車</option>
                        <option value="ev">EV（電気自動車）</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="classificationType2">分類</label>
                    <select id="classificationType2" onchange="toggle1NumberFields(2)">
                        <option value="passenger">3/5ナンバー（乗用車）</option>
                        <option value="cargo">1ナンバー（貨物車）</option>
                    </select>
                </div>
                <div class="input-group" id="passengerCapacityGroup2" style="display: none;">
                    <label for="passengerCapacity2">乗車定員数</label>
                    <input type="number" id="passengerCapacity2" value="2" min="1">
                    <span class="unit">人</span>
                </div>
                <div class="input-group" id="maxLoadingCapacityGroup2" style="display: none;">
                    <label for="maxLoadingCapacity2">最大積載量</label>
                    <input type="number" id="maxLoadingCapacity2" value="500" min="0">
                    <span class="unit">kg</span>
                </div>
                <div class="input-group" id="displacementGroup2">
                    <label for="displacement2">排気量</label>
                    <input type="number" id="displacement2" value="2000" min="0">
                    <span class="unit">cc</span>
                </div>
                <div class="input-group">
                    <label for="weight2">車両重量</label>
                    <input type="number" id="weight2" value="1500" min="0">
                    <span class="unit">kg</span>
                </div>
                <div class="input-group">
                    <label for="firstRegistrationDate2">新規車検登録日</label>
                    <input type="date" id="firstRegistrationDate2">
                </div>
                <div class="input-group">
                    <label for="isEcoCar2">エコカー減税対象</label>
                    <input type="checkbox" id="isEcoCar2" checked>
                    <p class="info-text">※初回車検時の重量税が免除されます</p>
                </div>
                <div class="input-group">
                    <label for="nextInspectionDate2">直近車検満了日</label>
                    <input type="date" id="nextInspectionDate2">
                </div>
                <div class="input-group">
                    <label for="inspectionCostPerTime2">車検時整備費用</label>
                    <input type="number" id="inspectionCostPerTime2" value="70000" min="0">
                    <span class="unit">円/回</span>
                    <p class="info-text">※法定費用（重量税・自賠責・印紙代）を除いた金額</p>
                </div>
                <div class="input-group">
                    <label for="voluntaryInsurance2">任意保険料</label>
                    <input type="number" id="voluntaryInsurance2" value="80000" min="0">
                    <span class="unit">円/年</span>
                </div>
                <div class="input-group">
                    <label for="parkingCostMonthly2">駐車場代</label>
                    <input type="number" id="parkingCostMonthly2" value="0" min="0">
                    <span class="unit">円/月</span>
                </div>
                <div class="input-group">
                    <label for="monthlyMileage2">月間走行距離</label>
                    <input type="number" id="monthlyMileage2" value="800" min="0">
                    <span class="unit">km/月</span>
                </div>
                <div class="input-group gas-diesel-hybrid-only" id="fuelEfficiencyGroup2">
                    <label for="fuelEfficiency2">燃費</label>
                    <input type="number" id="fuelEfficiency2" value="22" min="0.1" step="0.1">
                    <span class="unit">km/L</span>
                </div>
                <div class="input-group gas-diesel-hybrid-only" id="fuelPriceGroup2">
                    <label for="fuelPrice2">燃料価格</label>
                    <input type="number" id="fuelPrice2" value="170" min="0">
                    <span class="unit">円/L</span>
                </div>
                <div class="input-group ev-only" id="electricityEfficiencyGroup2" style="display: none;">
                    <label for="electricityEfficiency2">電費</label>
                    <input type="number" id="electricityEfficiency2" value="6" min="0.1" step="0.1">
                    <span class="unit">km/kWh</span>
                </div>
                 <div class="input-group ev-only" id="electricityPriceGroup2" style="display: none;">
                    <label for="electricityPrice2">電気料金単価</label>
                    <input type="number" id="electricityPrice2" value="30" min="0">
                    <span class="unit">円/kWh</span>
                </div>
                <div class="input-group diesel-only" id="adblueCostGroup2" style="display: none;">
                    <label for="adblueCostPerL2">AdBlue費用</label>
                    <input type="number" id="adblueCostPerL2" value="500" min="0">
                    <span class="unit">円/L</span>
                </div>
                <div class="input-group gas-diesel-hybrid-only" id="oilElementCostGroup2">
                    <label for="oilElementCostPerTime2">オイル・エレメント費用</label>
                    <input type="number" id="oilElementCostPerTime2" value="12000" min="0">
                    <span class="unit">円/回</span>
                    <p class="info-text" id="oilInfoText2">※目安: 5000km(D) / 10000km(G/HV)</p>
                </div>
                 <div class="input-group hybrid-ev-only" id="hvBatteryCostGroup2">
                    <label for="hvBatteryCost2">駆動用バッテリー費用</label>
                    <input type="number" id="hvBatteryCost2" value="250000" min="0">
                    <span class="unit">円/回</span>
                </div>
                <div class="input-group hybrid-ev-only" id="hvBatteryCycleGroup2">
                    <label for="hvBatteryCycle2">バッテリー交換サイクル</label>
                    <input type="number" id="hvBatteryCycle2" value="10" min="1">
                    <span class="unit">年</span>
                </div>
                <div class="input-group">
                    <label for="tireCostPerSet2">タイヤ費用</label>
                    <input type="number" id="tireCostPerSet2" value="80000" min="0">
                    <span class="unit">円/4本</span>
                </div>
                <div class="input-group">
                    <label for="otherMaintenanceCost2">その他メンテ費用</label>
                    <input type="number" id="otherMaintenanceCost2" value="30000" min="0">
                    <span class="unit">円/年</span>
                     <p class="info-text">※ブレーキ、補機バッテリー、ワイパー等</p>
                </div>
            </div>
        </div>

        <button onclick="calculateCarCosts()">計算する</button>

        <div class="result-section">
            <h2>計算結果</h2>
            <div class="result-group">
                <div class="result-item">
                    <h4><span id="vehicle1ResultName">車両 1</span> 総費用</h4>
                    <strong id="displayTotalCost1">0 円</strong>
                    <span class="monthly-avg" id="displayMonthlyAvg1"></span>
                </div>
                <div class="result-item" id="vehicle2ResultItem" style="display: none;">
                    <h4><span id="vehicle2ResultName">車両 2</span> 総費用</h4>
                    <strong id="displayTotalCost2">0 円</strong>
                    <span class="monthly-avg" id="displayMonthlyAvg2"></span>
                </div>
            </div>
            <hr>
            <h3>費用推移グラフ</h3>
            <div class="chart-controls">
                <label for="chartTypeSelect">グラフ表示項目:</label>
                <select id="chartTypeSelect" onchange="renderChart(window.allCalculatedMonthlyCosts)">
                    <option value="total">総費用</option>
                    <option value="loan">ローン</option>
                    <option value="fuel">燃料・電気代</option>
                    <option value="autoTax">自動車税</option>
                    <option value="inspection">車検関連費用</option>
                    <option value="insurance">任意保険</option>
                    <option value="parking">駐車場</option>
                    <option value="maintenance">メンテナンス</option>
                </select>
            </div>
            <div class="chart-container">
                <button class="csv-export-btn" onclick="downloadCSV()">CSV出力</button>
                <canvas id="cumulativeCostChart"></canvas>
            </div>
            <hr>
            <button class="toggle-section-button" onclick="toggleMonthlyBreakdown()">
                <span>月ごとの費用内訳を表示/非表示</span> <span class="arrow">▶</span>
            </button>
            <div class="monthly-breakdown-container" id="monthlyBreakdownTables">
                </div>
        </div>

        <p class="disclaimer">※この計算結果は一般的な条件に基づく目安です。実際の費用は、車種、地域、運転スタイル、各種契約内容により大きく異なります。税額は2024年時点の標準税率を参考にし、重課税も考慮していますが、エコカー減税の詳細は簡略化しています。</p>
    </div>

    <script>
        let cumulativeCostChart;
        window.allCalculatedMonthlyCosts = [];

        function getDaysInMonth(year, month) {
            return new Date(year, month + 1, 0).getDate();
        }
        function formatNumber(num) {
            return Math.round(num).toLocaleString();
        }

        function getAutoTax(displacement, elapsedYears, fuelType, classificationType, maxLoadingCapacity) {
            let tax = 0;
            if (classificationType === 'cargo') {
                if (maxLoadingCapacity <= 1000) {
                         if (displacement <= 1000) tax = 8000; else if (displacement <= 1500) tax = 11500; else tax = 14500;
                } else { tax = 11000 + Math.max(0, Math.ceil((maxLoadingCapacity-1000)/1000)) * 3000; }
            } else {
                if (displacement <= 1000) tax = 25000;
                else if (displacement <= 1500) tax = 30500; else if (displacement <= 2000) tax = 36000;
                else if (displacement <= 2500) tax = 43500; else if (displacement <= 3000) tax = 50000;
                else if (displacement <= 3500) tax = 57000; else if (displacement <= 4000) tax = 65500;
                else if (displacement <= 4500) tax = 75500; else if (displacement <= 6000) tax = 87000;
                else tax = 110000;
            }
            if (fuelType === 'diesel' && elapsedYears >= 11) { tax *= 1.15; }
            if ((fuelType === 'gasoline' || fuelType === 'hybrid') && elapsedYears >= 13) { tax *= 1.15; }
            return tax;
        }

        function getWeightTax(weight, elapsedYears, isEcoCar, isFirstInspection, classificationType) {
            if (isEcoCar && isFirstInspection) return 0;
            
            let taxPerYear = 0;
            if (classificationType === 'cargo') {
                taxPerYear = 2500 * Math.ceil(weight/1000);
                 if (elapsedYears >= 13) taxPerYear = 3400 * Math.ceil(weight/1000);
                 if (elapsedYears >= 18) taxPerYear = 3900 * Math.ceil(weight/1000);
            } else {
                 taxPerYear = 4100 * Math.ceil(weight/500);
                 if (elapsedYears >= 13) taxPerYear = 5700 * Math.ceil(weight/500);
                 if (elapsedYears >= 18) taxPerYear = 6300 * Math.ceil(weight/500);
            }
            return taxPerYear;
        }

        function getCompulsoryInsurance(classificationType) {
            return classificationType === 'cargo' ? 12850 : 17650;
        }
        
        function getStampDuty() { return 1800; }

        function toggleLoanFields(num) {
            document.getElementById(`loanFields${num}`).style.display = document.getElementById(`loanOption${num}`).value === 'yes' ? 'block' : 'none';
        }
        function toggle1NumberFields(num) {
            const isCargo = document.getElementById(`classificationType${num}`).value === 'cargo';
            document.getElementById(`passengerCapacityGroup${num}`).style.display = isCargo ? 'flex' : 'none';
            document.getElementById(`maxLoadingCapacityGroup${num}`).style.display = isCargo ? 'flex' : 'none';
        }

        function toggleFuelTypeFields(num) {
            const fuelType = document.getElementById(`fuelType${num}`).value;
            const groups = {
                'gas-diesel-hybrid-only': ['gasoline', 'diesel', 'hybrid'],
                'ev-only': ['ev'],
                'diesel-only': ['diesel'],
                'hybrid-ev-only': ['hybrid', 'ev']
            };

            for (const className in groups) {
                const elements = document.getElementById(`vehicle${num}Inputs`).querySelectorAll(`.${className}`);
                elements.forEach(el => {
                    el.style.display = groups[className].includes(fuelType) ? 'flex' : 'none';
                });
            }
            
            document.getElementById(`displacementGroup${num}`).style.display = (fuelType !== 'ev') ? 'flex' : 'none';
            
            const oilInfo = document.getElementById(`oilInfoText${num}`);
            if (oilInfo) {
                if(fuelType === 'diesel') oilInfo.textContent = '※目安: 5000km(D)';
                else oilInfo.textContent = '※目安: 10000km(G/HV)';
            }
        }
        
        function toggleVehicleComparison() {
            const isChecked = document.getElementById('compareVehicles').checked;
            document.getElementById('vehicle2Inputs').style.display = isChecked ? 'block' : 'none';
            document.getElementById('vehicle2ResultItem').style.display = isChecked ? 'block' : 'none';
            if (isChecked) {
                toggleFuelTypeFields(2);
                toggleLoanFields(2);
                toggle1NumberFields(2);
            }
            calculateCarCosts();
        }
        
        function toggleMonthlyBreakdown() {
            const container = document.getElementById('monthlyBreakdownTables');
            const button = document.querySelector('.toggle-section-button');
            const isExpanded = container.classList.toggle('expanded');
            button.classList.toggle('expanded', isExpanded);
            button.querySelector('.arrow').textContent = isExpanded ? '▼' : '▶';
        }

        function calculateCarCosts() {
            const startDateStr = document.getElementById('startDate').value;
            const endDateStr = document.getElementById('endDate').value;
            if (!startDateStr || !endDateStr) { alert('計算開始日と計算終了日を入力してください。'); return; }

            const startDate = new Date(startDateStr + 'T00:00:00');
            const endDate = new Date(endDateStr + 'T00:00:00');
            if (startDate > endDate) { alert('計算終了日は計算開始日より後の日付を設定してください。'); return; }

            let totalMonths = (endDate.getFullYear() - startDate.getFullYear()) * 12 + (endDate.getMonth() - startDate.getMonth()) + 1;
            
            const numberOfVehicles = document.getElementById('compareVehicles').checked ? 2 : 1;
            const allMonthlyCosts = [];

            for (let i = 1; i <= numberOfVehicles; i++) {
                const v = {
                    name: document.getElementById(`vehicle${i}Name`).value || `車両 ${i}`,
                    loanOption: document.getElementById(`loanOption${i}`).value,
                    loanAmount: parseFloat(document.getElementById(`loanAmount${i}`).value) || 0,
                    loanInterestRate: parseFloat(document.getElementById(`loanInterestRate${i}`).value) / 100 || 0,
                    loanTermMonths: parseInt(document.getElementById(`loanTermMonths${i}`).value) || 0,
                    fuelType: document.getElementById(`fuelType${i}`).value,
                    classificationType: document.getElementById(`classificationType${i}`).value,
                    maxLoadingCapacity: parseFloat(document.getElementById(`maxLoadingCapacity${i}`).value) || 0,
                    displacement: parseFloat(document.getElementById(`displacement${i}`).value) || 0,
                    weight: parseFloat(document.getElementById(`weight${i}`).value) || 0,
                    firstRegDateStr: document.getElementById(`firstRegistrationDate${i}`).value,
                    isEcoCar: document.getElementById(`isEcoCar${i}`).checked,
                    nextInspectionDateStr: document.getElementById(`nextInspectionDate${i}`).value,
                    inspectionBaseCost: parseFloat(document.getElementById(`inspectionCostPerTime${i}`).value) || 0,
                    voluntaryInsurance: parseFloat(document.getElementById(`voluntaryInsurance${i}`).value) || 0,
                    parkingCost: parseFloat(document.getElementById(`parkingCostMonthly${i}`).value) || 0,
                    monthlyMileage: parseFloat(document.getElementById(`monthlyMileage${i}`).value) || 0,
                    fuelEfficiency: parseFloat(document.getElementById(`fuelEfficiency${i}`).value) || 1,
                    fuelPrice: parseFloat(document.getElementById(`fuelPrice${i}`).value) || 0,
                    elecEfficiency: parseFloat(document.getElementById(`electricityEfficiency${i}`).value) || 1,
                    elecPrice: parseFloat(document.getElementById(`electricityPrice${i}`).value) || 0,
                    adblueCost: parseFloat(document.getElementById(`adblueCostPerL${i}`).value) || 0,
                    oilCost: parseFloat(document.getElementById(`oilElementCostPerTime${i}`).value) || 0,
                    hvBatteryCost: parseFloat(document.getElementById(`hvBatteryCost${i}`).value) || 0,
                    hvBatteryCycle: parseInt(document.getElementById(`hvBatteryCycle${i}`).value) || 10,
                    tireCost: parseFloat(document.getElementById(`tireCostPerSet${i}`).value) || 0,
                    otherMaintenanceCost: parseFloat(document.getElementById(`otherMaintenanceCost${i}`).value) || 0,
                };
                
                const firstRegDate = v.firstRegDateStr ? new Date(v.firstRegDateStr + 'T00:00:00') : null;
                if (!firstRegDate) { alert(`${v.name}の新規車検登録日を入力してください。`); return; }

                let monthlyLoanPayment = 0;
                if (v.loanOption === 'yes' && v.loanAmount > 0) {
                    const r = v.loanInterestRate / 12;
                    monthlyLoanPayment = r > 0 ? (v.loanAmount * r * Math.pow(1 + r, v.loanTermMonths)) / (Math.pow(1 + r, v.loanTermMonths) - 1) : v.loanAmount / v.loanTermMonths;
                }
                
                const monthlyCostsForVehicle = [];
                let totalMileage = 0;
                let loanMonthCounter = 0;

                let currentMonthIter = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
                while (currentMonthIter <= endDate) {
                    const year = currentMonthIter.getFullYear();
                    const month = currentMonthIter.getMonth();
                    
                    const elapsedYears = year - firstRegDate.getFullYear() + (month >= firstRegDate.getMonth() ? 0 : -1);

                    const detail = { date: `${year}年${(month + 1).toString().padStart(2, '0')}月`, loan: 0, fuel: 0, autoTax: 0, inspection: 0, insurance: 0, parking: 0, maintenance: 0, total: 0 };

                    if (v.loanOption === 'yes' && loanMonthCounter < v.loanTermMonths) {
                        detail.loan = monthlyLoanPayment;
                        loanMonthCounter++;
                    }

                    if (v.fuelType === 'ev') {
                        detail.fuel = (v.monthlyMileage / v.elecEfficiency) * v.elecPrice;
                    } else {
                        detail.fuel = (v.monthlyMileage / v.fuelEfficiency) * v.fuelPrice;
                    }
                    
                    if (month === 3) {
                        detail.autoTax = getAutoTax(v.displacement, elapsedYears, v.fuelType, v.classificationType, v.maxLoadingCapacity);
                    }
                    
                    if (month === 0) { detail.insurance = v.voluntaryInsurance; }

                    detail.parking = v.parkingCost;

                    detail.maintenance += v.otherMaintenanceCost / 12;
                    if ((v.fuelType === 'hybrid' || v.fuelType === 'ev') && elapsedYears > 0 && elapsedYears % v.hvBatteryCycle === 0) {
                         detail.maintenance += v.hvBatteryCost / 12;
                    }

                    const prevTotalMileage = totalMileage;
                    totalMileage += v.monthlyMileage;
                    if (v.fuelType === 'diesel' && Math.floor(totalMileage / 10000) > Math.floor(prevTotalMileage / 10000)) {
                        detail.maintenance += (Math.floor(totalMileage / 10000) - Math.floor(prevTotalMileage / 10000)) * 10 * v.adblueCost;
                    }
                    const oilInterval = (v.fuelType === 'diesel') ? 5000 : 10000;
                    if ((v.fuelType !== 'ev') && Math.floor(totalMileage / oilInterval) > Math.floor(prevTotalMileage / oilInterval)) {
                        detail.maintenance += v.oilCost;
                    }
                    if (Math.floor(totalMileage / 40000) > Math.floor(prevTotalMileage / 40000)) {
                        detail.maintenance += v.tireCost;
                    }

                    let isInspectionMonth = false;
                    const inspectionCycleYears = (v.classificationType === 'cargo') ? 1 : 2;
                    let firstInspectionYears = (v.classificationType === 'cargo') ? 2 : 3;
                    
                    if(v.nextInspectionDateStr) {
                         const nextInspDate = new Date(v.nextInspectionDateStr);
                         if (nextInspDate.getFullYear() === year && nextInspDate.getMonth() === month) {
                           isInspectionMonth = true;
                         }
                    } else {
                        let tempInspectionDate = new Date(firstRegDate);
                        tempInspectionDate.setFullYear(tempInspectionDate.getFullYear() + firstInspectionYears);
                        while (tempInspectionDate.getFullYear() < year || (tempInspectionDate.getFullYear() === year && tempInspectionDate.getMonth() < month)) {
                            tempInspectionDate.setFullYear(tempInspectionDate.getFullYear() + inspectionCycleYears);
                        }
                        if (tempInspectionDate.getFullYear() === year && tempInspectionDate.getMonth() === month) {
                            isInspectionMonth = true;
                        }
                    }

                    if (isInspectionMonth) {
                        const isFirst = Math.abs(elapsedYears - firstInspectionYears) < 1;
                        const weightTaxAmount = getWeightTax(v.weight, elapsedYears, v.isEcoCar, isFirst, v.classificationType) * inspectionCycleYears;
                        const insuranceAmount = getCompulsoryInsurance(v.classificationType);
                        const stampDuty = getStampDuty();
                        detail.inspection = v.inspectionBaseCost + weightTaxAmount + insuranceAmount + stampDuty;
                    }
                    
                    detail.total = detail.loan + detail.fuel + detail.autoTax + detail.inspection + detail.insurance + detail.parking + detail.maintenance;
                    monthlyCostsForVehicle.push(detail);

                    currentMonthIter.setMonth(currentMonthIter.getMonth() + 1);
                }

                const totalCost = monthlyCostsForVehicle.reduce((sum, d) => sum + d.total, 0);
                allMonthlyCosts.push({
                    name: v.name,
                    monthlyData: monthlyCostsForVehicle,
                    totalCost: totalCost,
                    avgMonthlyCost: totalCost / Math.max(1, totalMonths)
                });
            }

            window.allCalculatedMonthlyCosts = allMonthlyCosts;
            displayResults(allMonthlyCosts);
            renderChart(allMonthlyCosts);
            renderMonthlyTables(allMonthlyCosts);
        }
        
        function displayResults(allCosts) {
             document.getElementById('vehicle1ResultName').textContent = allCosts[0].name;
             document.getElementById('displayTotalCost1').textContent = formatNumber(allCosts[0].totalCost) + ' 円';
             document.getElementById('displayMonthlyAvg1').textContent = `(月平均 ${formatNumber(allCosts[0].avgMonthlyCost)} 円)`;

            if (allCosts.length > 1) {
                document.getElementById('vehicle2ResultName').textContent = allCosts[1].name;
                document.getElementById('displayTotalCost2').textContent = formatNumber(allCosts[1].totalCost) + ' 円';
                document.getElementById('displayMonthlyAvg2').textContent = `(月平均 ${formatNumber(allCosts[1].avgMonthlyCost)} 円)`;
            }
        }

        function renderMonthlyTables(allCosts) {
            const container = document.getElementById('monthlyBreakdownTables');
            container.innerHTML = '';
            
            allCosts.forEach(vehicleData => {
                let tableHtml = `<h3>${vehicleData.name} の月次費用内訳</h3>
                    <div class="monthly-breakdown-table-wrapper">
                        <table class="monthly-breakdown">
                            <thead><tr>
                                <th>月</th><th>ローン</th><th>燃料・電気代</th><th>自動車税</th><th>車検関連</th><th>任意保険</th><th>駐車場</th><th>メンテナンス</th><th>月合計</th>
                            </tr></thead><tbody>`;
                
                vehicleData.monthlyData.forEach(d => {
                    tableHtml += `<tr>
                        <td>${d.date}</td><td>${formatNumber(d.loan)}</td><td>${formatNumber(d.fuel)}</td><td>${formatNumber(d.autoTax)}</td>
                        <td>${formatNumber(d.inspection)}</td><td>${formatNumber(d.insurance)}</td><td>${formatNumber(d.parking)}</td>
                        <td>${formatNumber(d.maintenance)}</td><td>${formatNumber(d.total)}</td>
                    </tr>`;
                });
                
                tableHtml += `</tbody></table></div>`;
                container.innerHTML += tableHtml;
            });
        }
        
        function renderChart(allCosts) {
            const ctx = document.getElementById('cumulativeCostChart').getContext('2d');
            const chartType = document.getElementById('chartTypeSelect').value;

            if (cumulativeCostChart) cumulativeCostChart.destroy();
            if (!allCosts || allCosts.length === 0 || allCosts[0].monthlyData.length === 0) return;

            const labels = allCosts[0].monthlyData.map(m => m.date);
            const datasets = allCosts.map((vehicleData, index) => {
                let cumulative = 0;
                const data = vehicleData.monthlyData.map(m => {
                    const value = m[chartType] || 0;
                    if (chartType === 'total') {
                        cumulative += value;
                        return cumulative;
                    }
                    return value;
                });
                
                const colors = ['rgb(75, 192, 192)', 'rgb(255, 99, 132)'];
                return {
                    label: `${vehicleData.name} ${chartType === 'total' ? '累計' : ''}`,
                    data: data,
                    borderColor: colors[index],
                    backgroundColor: colors[index],
                    fill: false,
                };
            });

            cumulativeCostChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    plugins: {
                        title: { display: true, text: `費用推移グラフ`, font: { size: 18 } },
                        tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${formatNumber(ctx.raw)} 円` } }
                    },
                    scales: { y: { beginAtZero: true, ticks: { callback: val => formatNumber(val) } } }
                }
            });
        }
        
        // --- ▼▼▼ ここから修正箇所 ▼▼▼ ---
        async function downloadCSV() {
            if (!window.allCalculatedMonthlyCosts || window.allCalculatedMonthlyCosts.length === 0) {
                alert('先に計算を実行してください。');
                return;
            }

            // ヘッダーを「年月」「車両名」「月合計」に修正
            const headers = ['年月', '車両名', '月合計'];
            let csvContent = "\uFEFF" + headers.join(',') + '\r\n';

            // 出力データをヘッダーに合わせて修正
            window.allCalculatedMonthlyCosts.forEach(vehicleData => {
                vehicleData.monthlyData.forEach(d => {
                    const row = [
                        d.date.replace('年','-').replace('月',''),
                        vehicleData.name,
                        Math.round(d.total)
                    ];
                    csvContent += row.join(',') + '\r\n';
                });
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });

            // デフォルトのファイル名を生成 (yyyymmdd.csv)
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const fileName = `${yyyy}${mm}${dd}.csv`;

            // File System Access API (showSaveFilePicker) がサポートされているかチェック
            if (window.showSaveFilePicker) {
                try {
                    const fileHandle = await window.showSaveFilePicker({
                        suggestedName: fileName,
                        types: [{
                            description: 'CSV ファイル',
                            accept: { 'text/csv': ['.csv'] },
                        }],
                    });
                    const writable = await fileHandle.createWritable();
                    await writable.write(blob);
                    await writable.close();
                } catch (err) {
                    // ユーザーがダイアログをキャンセルした場合はエラーを無視
                    if (err.name !== 'AbortError') {
                        console.error('ファイルの保存に失敗しました:', err);
                        alert('ファイルの保存に失敗しました。');
                    }
                }
            } else {
                // APIがサポートされていない場合のフォールバック（従来のダウンロード方法）
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", fileName); // ファイル名を動的に設定
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url); // オブジェクトURLを解放
            }
        }
        // --- ▲▲▲ ここまで修正箇所 ▲▲▲ ---

        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            const fiveYearsLater = new Date(today);
            fiveYearsLater.setFullYear(today.getFullYear() + 5);

            const formatDate = (date) => date.toISOString().split('T')[0];

            document.getElementById('startDate').value = formatDate(today);
            document.getElementById('endDate').value = formatDate(fiveYearsLater);
            
            const fiveYearsAgo = new Date(today);
            fiveYearsAgo.setFullYear(today.getFullYear() - 5);
            document.getElementById('firstRegistrationDate1').value = formatDate(fiveYearsAgo);
            
            document.getElementById('firstRegistrationDate2').value = formatDate(today);
            const threeYearsLater = new Date(today);
            threeYearsLater.setFullYear(today.getFullYear() + 3);
            document.getElementById('nextInspectionDate2').value = formatDate(threeYearsLater);

            toggleFuelTypeFields(1);
            if(document.getElementById('compareVehicles').checked) {
                 toggleFuelTypeFields(2);
                 toggleLoanFields(2);
                 toggle1NumberFields(2);
            }
            toggleLoanFields(1);
            toggle1NumberFields(1);

            calculateCarCosts(); 
        });
    </script>
</body>
</html>
